# tools.py — add this class

class ScrollToLoadAllTool(BaseTool):
    """
    Scrolls the page smoothly until no new content loads.
    Ideal for infinite-scroll lists in Power Apps, SharePoint, Dynamics, etc.
    """
    def __init__(self, mcp: McpToolset):
        super().__init__(
            name="scroll_to_load_all",
            description=(
                "Scrolls the page until no new content appears (infinite scroll). "
                "Optionally pass max_scrolls (default 50) and delay_ms (default 800). "
                "Returns the number of items loaded or 'DONE'."
            ),
            parameters={
                "type": "object",
                "properties": {
                    "max_scrolls": {"type": "integer", "description": "Safety limit", "default": 50},
                    "delay_ms": {"type": "integer", "description": "Delay between scrolls", "default": 800},
                    "container_selector": {
                        "type": "string",
                        "description": "Optional CSS selector of the scrollable container (e.g. '[role=\"grid\"]')"
                    }
                }
            }
        )
        self.mcp = mcp

    async def execute(self, args, ctx) -> str:
        max_scrolls = args.get("max_scrolls", 50)
        delay_ms = args.get("delay_ms", 800)
        container = args.get("container_selector")

        script = """
        (async ({max_scrolls, delay_ms, container}) => {
            const scroller = container ? document.querySelector(container) : document.scrollingElement || document.documentElement;
            if (!scroller) return "ERROR: No scrollable element found";

            let lastHeight = scroller.scrollHeight || scroller.scrollHeight;
            let scrolls = 0;
            let stableCount = 0;

            while (scrolls < max_scrolls) {
                scroller.scrollTop = scroller.scrollHeight;
                await new Promise(r => setTimeout(r, delay_ms));

                const newHeight = scroller.scrollHeight || scroller.scrollHeight;
                if (newHeight === lastHeight) {
                    stableCount++;
                    if (stableCount >= 3) break; // no change for 3 checks → assume done
                } else {
                    stableCount = 0;
                }
                lastHeight = newHeight;
                scrolls++;
            }
            // Final smooth scroll to bottom
            scroller.scrollTop = scroller.scrollHeight;

            // Count visible rows (Power Apps uses role="row")
            const rows = document.querySelectorAll('[role="row"], [role="gridcell"]');
            return `DONE — Loaded ${rows.length} elements after ${scrolls} scrolls`;
        })(arguments[0])
        """

        try:
            result = await self.mcp.execute_tool(
                "playwright_evaluate",
                {"script": script, "arg": {"max_scrolls": max_scrolls, "delay_ms": delay_ms, "container": container}}
            )
            return str(result)
        except Exception as e:
            return f"ERROR during scroll: {e}"



instruction="""
You are a Queue Worker that creates items in Power Apps.

Follow this exact sequence EVERY time:

1. Call `load_session` first — this restores authentication.
2. Navigate to the Power Apps environment URL provided.
3. Click the correct app or "Tables" → "Queue Items" (or whatever the list is called).
4. Click the "+ New" button to create a new record.
5. Fill ALL fields using the DATA block provided above.
6. Click Save / Create.

AFTER creating the item:
7. Go back to the main list view.
8. Call `scroll_to_load_all` with these parameters:
   {
     "container_selector": "[role=\"presentation\"] [role=\"grid\"]", 
     "max_scrolls": 80,
     "delay_ms": 1000
   }
   → This forces the infinite list to load everything.
9. Only then search for the title you just created to confirm it exists.
10. Reply with "SUCCESS: Queue item created and verified" or the error.

Never skip the scroll step — the item will not appear otherwise.
"""




Step 1: Define the Scroll Script
Save this robust "infinite scroll" script as a string constant in your Python code so you can easily inject it into your prompt.

Python

INFINITE_SCROLL_JS = """
(async () => {
    let lastHeight = document.body.scrollHeight;
    while (true) {
        window.scrollTo(0, document.body.scrollHeight);
        await new Promise(r => setTimeout(r, 1000)); // Wait 1s for load
        let newHeight = document.body.scrollHeight;
        if (newHeight === lastHeight) break;
        lastHeight = newHeight;
    }
    return "Scroll complete";
})()
"""
Step 2: configure the Agent
When you set up your Gemini agent, give it the explicit instruction on how to scroll.

Python

from google import genai
from google.genai import types

# 1. Setup your MCP Client to connect to "npx @playwright/mcp@latest"
# (Assuming you have the MCP client connection code already set up here)

# 2. Create the System Instruction
# This is the "Magic" step. You teach the model that "scrolling" = "running this specific JS".
sys_instruction = f"""
You are a browser automation agent.
- You have access to a tool called `browser_evaluate`.
- IF the user asks you to "scroll to the bottom" or "find an item in an infinite list":
  You MUST use `browser_evaluate` and pass the following JavaScript code exactly as the `function` argument:
  
  {INFINITE_SCROLL_JS}
"""

# 3. Initialize the Client
client = genai.Client(api_key="YOUR_API_KEY")

# 4. Chat Session
chat = client.chats.create(
    model="gemini-2.0-flash-exp",
    config=types.GenerateContentConfig(
        system_instruction=sys_instruction,
        tools=[your_playwright_mcp_tools] # Pass the tools you loaded from the MCP server
    )
)

# 5. Run it
response = chat.send_message("Go to youtube.com/shorts and scroll down until you see a video about 'Cats'.")
Why this works
browser_evaluate is standard in @playwright/mcp@latest. It executes whatever string you give it inside the browser context.
