task_name: "Create Smart Mailbox Queue"
task_description: "Create a private Smart Mailbox Queue in Dynamics 365 Customer Service, test and enable the associated mailbox, and activate a record creation rule for automatic case creation from emails."

task_steps: |
  1. Start from the Power Platform admin center: Navigate to https://admin.powerplatform.microsoft.com/ or https://admin.microsoft.com/ → Environments → Select the target environment (e.g., 'WIM OPS POC') → Click 'Environment URL' link (e.g., 'wimopspoc.crm.dynamics.com') to open in a new tab. Let the agent handle login if prompted.

  CRITICAL: Wait 5 seconds for the full environment home page to load. Take a snapshot to confirm. DO NOT close any tabs prematurely.

  2. On the environment home page (apps list), handle any iframe: Locator('iframe[title="AppLandingPage"]').content_frame(). Wait 5 seconds for apps to load, then click the 'Copilot Service admin center' app tile. Take snapshot to confirm app opened.

  3. In Copilot Service admin center, from the left sitemap, select 'Queues' under 'Customer support'. Wait 5 seconds for page load, take snapshot.

  4. On the Queues page, click 'Manage' for 'Basic queues'. Wait 5 seconds for Basic Queues grid to fully load, take snapshot.

  5. In the command bar, click the exact 'New' button to create a new queue. Wait 5 seconds for the new record form to load.

  6. After form load, take snapshot to confirm the form title (should be 'New Queue' or similar). If the form fails to load or selectors don't match, stop and notify: "Form load failed after New click - check selectors or UI."

  7. CONDITIONAL: Check if the current entity is wrong (e.g., form title contains 'New Information' or fields lack 'Type' dropdown for queue). If so, click the entity selector button, then select 'Queue' from the options. Wait 5 seconds for form to reload as Queue, take snapshot to confirm correct entity (e.g., 'Type' field visible). If selector not found or fails, stop and notify: "Entity selector failed - wrong entity type detected."

  8. Fill the form in the SUMMARY section with exact values:
     - Name: "O2A SMART DEMO Mailbox" (append unique_id if duplicates exist)
     - Type: Select "Private" from the dropdown
     - Incoming Email: "mailbox11@wellsfargo.com" (type exactly; replace for real test)
     - Description: "Demo smart mailbox for testing" (optional)
     - Leave other fields default

  9. In the Omnichannel section (may be on Conflicts tab): Set 'Automatic work distribution' to 'No' (required for basic queue).

  10. Click the exact 'Save' button in the top command bar (NOT Save & Close). Wait 5 seconds for save to complete, confirm via success message or refreshed form. Take snapshot.

  11. After save, under EMAIL SETTINGS, click the 'Mailbox' hyperlink to open the auto-created mailbox record. Wait 5 seconds for Mailbox form to load, take snapshot.

  12. In the Mailbox form:
      - Set 'Allow to Use Credentials for Email Processing' to 'Yes' (if not default)
      - Configure Incoming/Outgoing Server Type and protocols (e.g., 'Exchange Server' or 'Server-Side Synchronization' based on org)
      - If 'Approve Email' button appears, click it and confirm any popup

  13. Click 'Test & Enable Mailbox' in the command bar. Wait 10 seconds for test to run (monitor for green checkmarks). If fails (e.g., permissions error), stop and notify: "Mailbox test failed - check alerts."

  14. If test succeeds, close success dialog. Click 'Save & Close' on Mailbox form to return to Queue form. Wait 5 seconds, take snapshot.

  15. On Queue form, in 'RECORD CREATION AND UPDATE RULES' subgrid: Click 'Add Existing Record Creation and Update Rule' (or 'New' if no existing). If adding existing: Search/select "O2A Demo mailbox rule for test", click 'Add'. If creating new: Fill Name="O2A Demo mailbox rule for test", Source Type="Email", Queue= current queue, Record to Create="Case". Save.

  16. Check the checkbox next to the added/created rule in the subgrid to enable it.

  17. Click three dots ('More commands') next to the rule, select 'Activate', confirm popup with 'Activate'. Wait 5 seconds for activation (status=Active), take snapshot.

  18. Take final snapshot of Queue form showing activated rule, enabled mailbox, and details.

  19. IMMEDIATELY NOTIFY: "Task (Create Smart Mailbox) completed successfully! Browser left open for review." DO NOT close the browser.

# CRITICAL SELECTORS (stable in 2024-2025 Dynamics UI - prioritize data-id)
selectors:
  environment_url_link: "a[href*='.crm.dynamics.com']"  # Exact env URL click
  app_tile: "div[data-id='app-tile-copilot-service-admin-center']"
  queues_manage_basic: "button[data-test-id='basic-queue-manage']"
  new_button: "button[data-id='queue|NoRelationship|HomePageGrid|Mscrm.HomepageGrid.queue.NewRecord']"
  entity_selector_button: "button[data-id='recordTypeSelector']"  # For multi-entity; click then select 'Queue'
  save_button: "button[data-id='queue|NoRelationship|Form|Mscrm.Form.queue.Save']"
  mailbox_link: "a[data-id='mailbox.fieldControl-LookupResultsPopup']"
  test_enable_mailbox: "button[data-id='mailbox|NoRelationship|Form|Mscrm.Form.mailbox.TestAndEnable']"
  add_rule_button: "button[data-id='msdyn_recordcreationandupdaterule|NoRelationship|SubGridAssociated|Mscrm.SubGrid.msdyn_recordcreationandupdaterule.AddExistingStandard']"
  rule_checkbox: "input[type='checkbox'][aria-label*='O2A Demo mailbox rule']"
  more_commands_dots: "button[aria-label='More commands for Record Creation and Update Rule']"
  activate_button: "button[data-id='msdyn_recordcreationandupdaterule|NoRelationship|Form|Mscrm.Form.msdyn_recordcreationandupdaterule.Activate']"

# FORM FIELD FALLBACKS (XPath if data-id fails)
queue_name: "//input[@data-id='name.fieldControl-text-box-text']"
queue_type: "//select[@data-id='typecode.fieldControl-option-set-select']"
incoming_email: "//input[@data-id='emailaddress.fieldControl-text-box-text']"
auto_work_dist: "//select[@data-id='msdyn_isomnichannelqueue.fieldControl-option-set-select']"  # For No (basic queue)

# RULES TO PREVENT HALLUCINATION, SELECTOR FAILURES, AND EARLY CLOSURE
- ALWAYS navigate via UI clicks from admin center - NEVER guess internal URLs.
- Wait 5 seconds MINIMUM after EVERY navigation, save, or click. Confirm EVERY load/click with a snapshot describing the page (e.g., "New Queue form loaded correctly").
- Handle iframes: Use .content_frame() for app landing/embeds.
- If ANY popup (activation, errors), handle explicitly: Click confirm if expected, else stop/notify.
- If wrong entity ('Information'), use entity_selector_button - if not found, stop/notify without closing.
- If 'Email already in use' or any failure, stop/notify immediately - DO NOT proceed or close.
- NEVER use keyboard shortcuts (e.g., CTRL+S) - always click visible buttons.
- On selector failure, log error and notify - DO NOT assume or hallucinate alternatives.
- DO NOT close the browser AT ANY POINT, even on success/error - leave final Queue form open for user verification.
# agent.py
import os
from google.adk.agents import LlmAgent
from google.adk.tools.mcp_tool.mcp_toolset import MCPToolset
from google.adk.tools.mcp_tool.mcp_session_manager import StdioConnectionParams
from mcp import StdioServerParameters
from pydantic import BaseModel

# Define a tool to get credentials
class GetCredentialsInput(BaseModel):
    pass  # No input needed

def get_credentials(input: GetCredentialsInput) -> dict:
    """
    Retrieves the username and password for Microsoft admin login.
    Returns a dictionary with 'username' and 'password'.
    """
    username = os.environ.get("MS_USERNAME", "kavitha.kolahalam@wellsfargo.com")
    password = os.environ.get("MS_PASSWORD", "default_password")
    return {"username": username, "password": password}

# URLs as constants
POWER_PLATFORM_URL = "https://admin.powerplatform.microsoft.com/"
M365_ADMIN_URL = "https://admin.microsoft.com/"

root_agent = LlmAgent(
    model="gemini-2.0-flash",  # Adjust to available model
    name="dynamics_automator",
    description="An AI agent that automates business unit and team creation in Microsoft Power Platform using natural language processing of steps.",
    instruction="""
You are an automation agent that processes natural language steps to perform browser actions in the Microsoft Power Platform admin center. To avoid rate limiting, incorporate delays: after each major action (e.g., click 'Save', create entity), use browser_wait_for with timeout=5000-10000ms (5-10 seconds) even if not needed for load, to pace requests and prevent throttling. Use up to 10 retries for failures, but space retries with increasing delays (e.g., 5s, 10s, 20s). Monitor for 429 errors or throttle messages in snapshots; if detected, pause longer (30s+). Use snapshots before actions, long waits for MFA (120s timeout for manual approval in headed browser), scrolls, refreshes.

To add pauses for manual intervention, after each of steps 1-5, use browser_wait_for with a long timeout=60000ms (1 minute) to pause execution, allowing time for manual checks before resuming automatically.

Natural language task steps:
1. Navigate to 'https://admin.powerplatform.microsoft.com'. Wait for load, then delay 5000ms. [Pause: browser_wait_for timeout=60000ms for manual intervention, then resume.]
2. Click textbox 'Enter your email or phone', fill with username from get_credentials, click 'Next'. Delay 5000ms. [Pause: browser_wait_for timeout=60000ms for manual intervention, then resume.]
3. For MFA, wait 120s for manual approval, then wait for URL '/home'. Delay 5000ms after load. [Pause: browser_wait_for timeout=60000ms for manual intervention, then resume.]
4. Click tab 'Manage users, environments'. Delay 5000ms. [Pause: browser_wait_for timeout=60000ms for manual intervention, then resume.]
5. Click link 'WIM OPS POC', wait for URL matching '/manage/environments/environment.*'. Delay 5000ms. [Pause: browser_wait_for timeout=60000ms for manual intervention, then resume.]
6. Click link 'See all Business units'. Delay 5000ms.
7. Click menuitem 'New business unit'. Delay 5000ms.
8. Click textbox 'Name *', fill 'COO O2A PARENT DEMO557'. Delay 5000ms.
9. Click button 'Save', wait 2000ms, then additional delay 10000ms to avoid throttle.
10. Click 'New business unit' again. Delay 5000ms.
11. Click textbox 'Name *', fill 'COO O2A CHILD DEMO557'. Delay 5000ms.
12. Click button 'Cancel wimopspoc' if present (or handle dialog). Delay 5000ms.
13. Click combobox 'Parent business unit dropdown', fill 'COO', click option 'COO O2A PARENT DEMO'. Delay 5000ms.
14. Click 'Save', wait 2000ms, then additional delay 10000ms.
15. Click tab 'Manage users, environments'. Delay 5000ms.
16. Click 'WIM OPS POC'. Delay 5000ms.
17. Click link 'See all Teams'. Delay 5000ms.
18. Click menuitem 'Create team'. Delay 5000ms.
19. Click textbox 'Team name *', fill 'COO O2A TEAMS DEMO557'. Delay 5000ms.
20. Click textbox 'Description', fill 'Test demo descript'. Delay 5000ms.
21. Click combobox 'Business unit', fill 'COO', click option 'COO O2A CHILD DEMO557'. Delay 5000ms.
22. Wait 2000ms, then delay 5000ms.
23. Click combobox 'Administrator', fill 'MTC', click option 'Mitchell Jones'. Delay 5000ms.
24. Click option 'Microsoft Entra ID Security'. Delay 5000ms.
25. Click combobox 'People Picker', fill 'ctc', click option 'DTCA CFG Dynamics365_S MMS_TEST'. Delay 5000ms.
26. Click text 'Members and guests'. Delay 5000ms.
27. Click option 'Owners'. Delay 5000ms.
28. Click button 'Next'. Delay 10000ms after save.
29. Complete any remaining steps for team save/creation, with delays.
30. If needed, proceed to shared mailbox in M365 admin (navigate to 'https://admin.microsoft.com', handle login/MFA with 120s wait, create 'Smart Mailbox', add members, block sign-in), adding 5000-10000ms delays after each action.
31. Back to Power Platform, create queue 'Smart Queue' with shared mailbox email, owner as new team, with delays.
32. Approve and enable mailbox, confirm success, with delays.
33. Output "Task completed successfully." and close browser only at end.

Use browser_snapshot to locate elements by role and name (e.g., role='textbox', name='Name *'). Before interactions, confirm presence. For fails, retry with wait, scroll ('PageDown' x5), resnapshot, but add delay before retry.
Handle dialogs. Use browser_wait_for for loads/timeouts/pauses, explicitly add delays to pace API calls. For combos, use browser_type then browser_click option.
Start upon 'Start automation'.
""",
    tools=[
        get_credentials,
        MCPToolset(
            connection_params=StdioConnectionParams(
                server_params=StdioServerParameters(
                    command="npx",
                    args=[
                        "-y",
                        "@playwright/mcp@latest",
                        "--headless=false",
                        "--slow-mo=2000",  # Increased slow-mo to 2s per action for better pacing
                    ],
                ),
            ),
            tool_filter=[
                "browser_navigate",
                "browser_click",
                "browser_type",
                "browser_snapshot",
                "browser_wait_for",
                "browser_select_option",
                "browser_press_key",
                "browser_handle_dialog",
                "browser_close",
            ],
        ),
    ],
)
