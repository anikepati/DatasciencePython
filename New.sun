task_name: "Create Smart Mailbox Queue"
task_description: "Create a private Smart Mailbox (Intelligent Emailhub Queue) in Dynamics 365 and activate the corresponding mailbox record rule."

task_steps: |
  1. Navigate to https://admin.powerplatform.microsoft.com/ or https://admin.microsoft.com/ → Environments → select your target environment → Open environment → Settings → Service Management → Email Configuration → Queues (the exact URL after login is usually something like https://[yourorg].crm.dynamics.com/main.aspx?appid=...&pagetype=entitylist&type=126&viewid=... but let the agent navigate naturally).

  CRITICAL: You MUST wait for the full Queues grid to load before proceeding.

  2. In the command bar at the top, click the exact button text "New" (not "New Queue", just "New").

  3. Wait for the "New Queue" form to fully load (you will see the "Queue" form with fields like Name, Type, etc.).

  4. Fill the form with these exact values:
     - Name: "O2A SMART DEMO Mailbox"
     - Type: select "Private" from the dropdown
     - Incoming Email: mailbox11@wellsfargo.com   ← type this exactly (or the real target email)
     - Leave all other fields default for now

  5. Click the exact "Save" button in the top command bar (NOT Save & Close yet).

  6. After save succeeds, stay on the same record. In the command bar click "Email Settings" or "Mailbox" (the button that opens the mailbox configuration for this queue).

  7. Wait for the Mailbox record to load (you will see fields like "Incoming Server Location", "Outgoing Server Location", etc.).

  8. In the Mailbox form:
     - Set "Allow to Use Credentials for Email Processing" = Yes
     - Set "Incoming Authentication Protocol" = Server-side synchronization or Office 365 (whatever is used in your org)
     - Set "Outgoing Authentication Protocol" = same as above

  9. Still on the Mailbox record, click the "Test & Enable Mailbox" button in the command bar.

  10. Wait for the test to complete successfully (you should see green checkmarks).

  11. If test passes, click "Approve Email" if prompted, then close the test dialog.

  12. Back on the Queue record, click "Save & Close".

  13. Now navigate to Settings → Service Management → Mailbox Record Creation and Update Rules (or directly search for "Record Creation and Update Rules" in the sitemap).

  14. Click "New" → choose "Mailbox" as the source type.

  15. Fill the rule:
      - Name: "O2A Demo mailbox rule for test"
      - Mailbox: lookup and select the mailbox you just created ("O2A SMART DEMO Mailbox" private queue)
      - Record Creation: create "Case" records (or whatever your org uses)

  16. Save the rule.

  17. Open the rule again → click "Activate" in the command bar → confirm the popup.

  18. Take final screenshot of the activated rule and the queue showing the mailbox is approved.

  IMMEDIATELY NOTIFY: "Task 5 (Create Smart Mailbox) completed successfully!"

# CRITICAL SELECTORS (use these exact selectors when possible – they are stable in 2024-2025 Dynamics versions)
selectors:
  new_queue_button: "button[data-id='queue|NoRelationship|HomePageGrid|queue.command.new']"
  save_button: "button[data-id*='.Save']"
  save_and_close_button: "button[data-id*='.SaveAndClose']"
  email_settings_button: "button[data-id='queue|NoRelationship|Form|queue.form.mailbox']"
  test_enable_mailbox: "button[data-id='mailbox|NoRelationship|Form|mailbox.TestAndEnableMailbox']"
  activate_rule: "button[data-id='recordcreationrule|NoRelationship|Form|recordcreationrule.Activate']"

# FORM FIELD XPATH FALLBACKS (only if data-id fails)
queue_name_field: "//input[@data-id='name.fieldControl-text-box-text']"
queue_type_dropdown: "//select[@data-id='typecode.fieldControl-option-set-select']"
incoming_email_field: "//input[@data-id='emailaddress.fieldControl-text-box-text']"

# RULES TO PREVENT HALLUCINATION
- NEVER guess URLs – always click through the UI from the admin center.
- NEVER click "Save" using keyboard shortcuts in instructions – always click the visible Save button.
- Always wait 3-5 seconds after every major navigation or save.
- Always take a screenshot after every major step with a clear description.
- If any popup says "Email address already in use" or similar – stop and report it immediately.
- Do NOT close the browser at the end – leave the final queue/mailbox/rule open for user verification.
# agent.py
import os
from google.adk.agents import LlmAgent
from google.adk.tools.mcp_tool.mcp_toolset import MCPToolset
from google.adk.tools.mcp_tool.mcp_session_manager import StdioConnectionParams
from mcp import StdioServerParameters
from pydantic import BaseModel

# Define a tool to get credentials
class GetCredentialsInput(BaseModel):
    pass  # No input needed

def get_credentials(input: GetCredentialsInput) -> dict:
    """
    Retrieves the username and password for Microsoft admin login.
    Returns a dictionary with 'username' and 'password'.
    """
    username = os.environ.get("MS_USERNAME", "kavitha.kolahalam@wellsfargo.com")
    password = os.environ.get("MS_PASSWORD", "default_password")
    return {"username": username, "password": password}

# URLs as constants
POWER_PLATFORM_URL = "https://admin.powerplatform.microsoft.com/"
M365_ADMIN_URL = "https://admin.microsoft.com/"

root_agent = LlmAgent(
    model="gemini-2.0-flash",  # Adjust to available model
    name="dynamics_automator",
    description="An AI agent that automates business unit and team creation in Microsoft Power Platform using natural language processing of steps.",
    instruction="""
You are an automation agent that processes natural language steps to perform browser actions in the Microsoft Power Platform admin center. To avoid rate limiting, incorporate delays: after each major action (e.g., click 'Save', create entity), use browser_wait_for with timeout=5000-10000ms (5-10 seconds) even if not needed for load, to pace requests and prevent throttling. Use up to 10 retries for failures, but space retries with increasing delays (e.g., 5s, 10s, 20s). Monitor for 429 errors or throttle messages in snapshots; if detected, pause longer (30s+). Use snapshots before actions, long waits for MFA (120s timeout for manual approval in headed browser), scrolls, refreshes.

To add pauses for manual intervention, after each of steps 1-5, use browser_wait_for with a long timeout=60000ms (1 minute) to pause execution, allowing time for manual checks before resuming automatically.

Natural language task steps:
1. Navigate to 'https://admin.powerplatform.microsoft.com'. Wait for load, then delay 5000ms. [Pause: browser_wait_for timeout=60000ms for manual intervention, then resume.]
2. Click textbox 'Enter your email or phone', fill with username from get_credentials, click 'Next'. Delay 5000ms. [Pause: browser_wait_for timeout=60000ms for manual intervention, then resume.]
3. For MFA, wait 120s for manual approval, then wait for URL '/home'. Delay 5000ms after load. [Pause: browser_wait_for timeout=60000ms for manual intervention, then resume.]
4. Click tab 'Manage users, environments'. Delay 5000ms. [Pause: browser_wait_for timeout=60000ms for manual intervention, then resume.]
5. Click link 'WIM OPS POC', wait for URL matching '/manage/environments/environment.*'. Delay 5000ms. [Pause: browser_wait_for timeout=60000ms for manual intervention, then resume.]
6. Click link 'See all Business units'. Delay 5000ms.
7. Click menuitem 'New business unit'. Delay 5000ms.
8. Click textbox 'Name *', fill 'COO O2A PARENT DEMO557'. Delay 5000ms.
9. Click button 'Save', wait 2000ms, then additional delay 10000ms to avoid throttle.
10. Click 'New business unit' again. Delay 5000ms.
11. Click textbox 'Name *', fill 'COO O2A CHILD DEMO557'. Delay 5000ms.
12. Click button 'Cancel wimopspoc' if present (or handle dialog). Delay 5000ms.
13. Click combobox 'Parent business unit dropdown', fill 'COO', click option 'COO O2A PARENT DEMO'. Delay 5000ms.
14. Click 'Save', wait 2000ms, then additional delay 10000ms.
15. Click tab 'Manage users, environments'. Delay 5000ms.
16. Click 'WIM OPS POC'. Delay 5000ms.
17. Click link 'See all Teams'. Delay 5000ms.
18. Click menuitem 'Create team'. Delay 5000ms.
19. Click textbox 'Team name *', fill 'COO O2A TEAMS DEMO557'. Delay 5000ms.
20. Click textbox 'Description', fill 'Test demo descript'. Delay 5000ms.
21. Click combobox 'Business unit', fill 'COO', click option 'COO O2A CHILD DEMO557'. Delay 5000ms.
22. Wait 2000ms, then delay 5000ms.
23. Click combobox 'Administrator', fill 'MTC', click option 'Mitchell Jones'. Delay 5000ms.
24. Click option 'Microsoft Entra ID Security'. Delay 5000ms.
25. Click combobox 'People Picker', fill 'ctc', click option 'DTCA CFG Dynamics365_S MMS_TEST'. Delay 5000ms.
26. Click text 'Members and guests'. Delay 5000ms.
27. Click option 'Owners'. Delay 5000ms.
28. Click button 'Next'. Delay 10000ms after save.
29. Complete any remaining steps for team save/creation, with delays.
30. If needed, proceed to shared mailbox in M365 admin (navigate to 'https://admin.microsoft.com', handle login/MFA with 120s wait, create 'Smart Mailbox', add members, block sign-in), adding 5000-10000ms delays after each action.
31. Back to Power Platform, create queue 'Smart Queue' with shared mailbox email, owner as new team, with delays.
32. Approve and enable mailbox, confirm success, with delays.
33. Output "Task completed successfully." and close browser only at end.

Use browser_snapshot to locate elements by role and name (e.g., role='textbox', name='Name *'). Before interactions, confirm presence. For fails, retry with wait, scroll ('PageDown' x5), resnapshot, but add delay before retry.
Handle dialogs. Use browser_wait_for for loads/timeouts/pauses, explicitly add delays to pace API calls. For combos, use browser_type then browser_click option.
Start upon 'Start automation'.
""",
    tools=[
        get_credentials,
        MCPToolset(
            connection_params=StdioConnectionParams(
                server_params=StdioServerParameters(
                    command="npx",
                    args=[
                        "-y",
                        "@playwright/mcp@latest",
                        "--headless=false",
                        "--slow-mo=2000",  # Increased slow-mo to 2s per action for better pacing
                    ],
                ),
            ),
            tool_filter=[
                "browser_navigate",
                "browser_click",
                "browser_type",
                "browser_snapshot",
                "browser_wait_for",
                "browser_select_option",
                "browser_press_key",
                "browser_handle_dialog",
                "browser_close",
            ],
        ),
    ],
)
